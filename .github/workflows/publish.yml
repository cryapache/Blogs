name: åšå®¢å‘å¸ƒå·¥ä½œæµ

on:
  push:
    branches: [ master ]
    paths:
      - 'blogs/*.md'

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›ï¸ Checkout ä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 2

      - name: ğŸ è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: pip install -r scripts/requirements.txt

      - name: ğŸ”„ æ‰¹é‡å‘å¸ƒæ‰€æœ‰å˜æ›´çš„åšå®¢æ–‡ç« 
        env:
          CNBLOGS_COOKIE: ${{ secrets.CNBLOGS_COOKIE }}
          CNBLOGS_XSRF_TOKEN: ${{ secrets.CNBLOGS_XSRF_TOKEN }}
        run: |
          # è·å–æœ¬æ¬¡æäº¤ä¸­æ–°å¢(A)æˆ–ä¿®æ”¹(M)çš„ blogs/ ä¸‹çš„ .md æ–‡ä»¶
          echo "ğŸ” æ­£åœ¨æ£€æµ‹å˜æ›´çš„ Markdown æ–‡ä»¶..."
          files=$(git diff --name-only --diff-filter=AM HEAD~1 HEAD | grep '^blogs/.*\.md$')
          
          if [ -z "$files" ]; then
            echo "âŒ æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ .md æ–‡ä»¶ï¼ˆæ–°å¢æˆ–ä¿®æ”¹ï¼‰"
            exit 1
          fi

          echo "âœ… æ£€æµ‹åˆ°ä»¥ä¸‹æ–‡ä»¶ï¼š"
          echo "$files"

          # é€ä¸ªå‘å¸ƒ
          any_modified=false
          while IFS= read -r file; do
            if [ -n "$file" ] && [ -f "$file" ]; then
              echo ""
              echo "ğŸ“¤ æ­£åœ¨å¤„ç†: $file"
              
              # è®°å½•å‘å¸ƒå‰çš„æ–‡ä»¶çŠ¶æ€ï¼ˆç”¨äºåˆ¤æ–­æ˜¯å¦æ³¨å…¥äº† post_idï¼‰
              before_hash=$(sha256sum "$file")
              
              # è°ƒç”¨å‘å¸ƒè„šæœ¬
              python scripts/publish_to_cnblogs.py "$file"
              
              # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦è¢«ä¿®æ”¹ï¼ˆå³æ³¨å…¥äº† post_idï¼‰
              after_hash=$(sha256sum "$file")
              if [ "$before_hash" != "$after_hash" ]; then
                echo "âœ¨ $file å·²æ›´æ–° post_id"
                git add "$file"
                any_modified=true
              else
                echo "â„¹ï¸ $file æ— å˜åŒ–ï¼ˆå¯èƒ½å·²æ˜¯å·²å‘å¸ƒæ–‡ç« ï¼‰"
              fi
            fi
          done <<< "$files"

          # å¦‚æœæœ‰æ–‡ä»¶è¢«ä¿®æ”¹ï¼Œæäº¤å¹¶æ¨é€
          if [ "$any_modified" = true ]; then
            echo ""
            echo "ğŸ’¾ æ­£åœ¨æäº¤æ›´æ–°åçš„æ–‡ä»¶..."
            git config --global user.name "github-actions[bot]"
            git config --global user.email "github-actions[bot]@users.noreply.github.com"
            git commit -m "chore: auto inject post_id for published posts"
            git push
            echo "âœ… å·²æˆåŠŸæ¨é€ post_id æ›´æ–°ï¼"
          else
            echo ""
            echo "â„¹ï¸ æœ¬æ¬¡æ— æ–°æ–‡ç« å‘å¸ƒï¼Œæ— éœ€æäº¤ã€‚"
          fi