---
title: ä½¿ç”¨è„šæœ¬å°†ç¬”è®°åŒæ­¥æ›´æ–°åˆ°åšå®¢ä¸Š
tags:
  - åšå®¢å›­
  - è‡ªåŠ¨åŒ–è„šæœ¬
  - github
draft: "false"
post_id: 19258999
---
ä¸‹é¢ä»¥è‡ªåŠ¨æ›´æ–°åˆ°åšå®¢å›­ä¸ºä¾‹ï¼š
### å‡†å¤‡ç¬”è®°ä»“åº“
ç»“æ„å¤§æ¦‚å¦‚ä¸‹ï¼š
```

repo/
|----blogs/
|     |----ä½¿ç”¨è„šæœ¬å°†ç¬”è®°åŒæ­¥æ›´æ–°åˆ°åšå®¢ä¸Š.md  #åšå®¢å†…å®¹
|----scripts/
|     |----publish_to_cnblogs.py          #è‡ªåŠ¨å‘å¸ƒè„šæœ¬
|     |----requirements.txt               #è„šæœ¬ä¾èµ–
|----.github/
|     |----workflows/
|           |----publish.yml              #githubå·¥ä½œæµé…ç½®
```
ä»¥ååœ¨blogsç›®å½•é‡Œå†™åšå®¢å°±å¯ä»¥äº†ã€‚

### è·å–åšå®¢çš„ç™»å½•ä¸å‘å¸ƒæ¥å£
åœ¨åšå®¢ç½‘ç«™ä¸Šå‘å¸ƒä¸€æ¡åšå®¢ï¼ŒæŠ“åŒ…ç½‘ç»œè¯·æ±‚è·å–ç›¸å…³æ¥å£ä¿¡æ¯

### ç¼–å†™å‘å¸ƒåšå®¢çš„è„šæœ¬
è¿™é‡Œç”¨pythonå†™äº†ä¸ªå‘åšå®¢å›­å‘å¸ƒåšå®¢çš„è„šæœ¬ï¼Œç›´æ¥æ‹¿æ¥ç”¨çš„è¯è®°å¾—æŠŠ`COOKIE`å’Œ`XSRF_TOKEN`æ¢æˆè‡ªå·±çš„ã€‚å¦‚æœä»“åº“å…¬å¼€çš„è¯å»ºè®®æ”¾åœ¨ç¯å¢ƒå˜é‡é‡Œä¸è¦æ˜æ–‡å­˜åœ¨è„šæœ¬é‡Œ
```python
# -*- coding: utf-8 -*-

"""

åšå®¢å›­è‡ªåŠ¨åŒ–å‘å¸ƒ/æ›´æ–°è„šæœ¬

- æ”¯æŒé¦–æ¬¡å‘å¸ƒè‡ªåŠ¨æ³¨å…¥ post_id

- åç»­ä¿®æ”¹è‡ªåŠ¨æ›´æ–°å·²æœ‰æ–‡ç« 

- å®Œæ•´ä¿ç•™ Front Matter ç»“æ„

"""

  

import sys

import os

import re

import yaml

import requests

from datetime import datetime, timezone

from pathlib import Path

  

# ==============================

# ğŸ”‘ è®¤è¯ä¿¡æ¯ï¼ˆä»ç¯å¢ƒå˜é‡è¯»å–ï¼Œå®‰å…¨ï¼ï¼‰

# ==============================

COOKIE = os.getenv("CNBLOGS_COOKIE")

XSRF_TOKEN = os.getenv("CNBLOGS_XSRF_TOKEN")

  

if not COOKIE or not XSRF_TOKEN:

Â  Â  print("âŒ é”™è¯¯ï¼šè¯·è®¾ç½®ç¯å¢ƒå˜é‡ CNBLOGS_COOKIE å’Œ CNBLOGS_XSRF_TOKEN", file=sys.stderr)

Â  Â  print("æç¤ºï¼šä»æµè§ˆå™¨å¼€å‘è€…å·¥å…·ä¸­å¤åˆ¶ .Cnblogs.AspNetCore.Cookies å’Œ XSRF-TOKEN çš„å€¼", file=sys.stderr)

Â  Â  sys.exit(1)

  
  

# ==============================

# ğŸ“„ è§£æ Front Matter

# ==============================

def parse_front_matter(content: str):

Â  Â  lines = content.splitlines()

Â  Â  if len(lines) < 3 or lines[0] != "---":

Â  Â  Â  Â  return {}, content

  

Â  Â  end_idx = -1

Â  Â  for i in range(1, len(lines)):

Â  Â  Â  Â  if lines[i].strip() == "---":

Â  Â  Â  Â  Â  Â  end_idx = i

Â  Â  Â  Â  Â  Â  break

Â  Â  if end_idx == -1:

Â  Â  Â  Â  return {}, content

  

Â  Â  fm_yaml = "\n".join(lines[1:end_idx])

Â  Â  body = "\n".join(lines[end_idx + 1:]).lstrip()

  

Â  Â  try:

Â  Â  Â  Â  meta = yaml.safe_load(fm_yaml) or {}

Â  Â  except yaml.YAMLError:

Â  Â  Â  Â  return {}, content

  

Â  Â  # æ ‡å‡†åŒ– draft

Â  Â  if "draft" in meta:

Â  Â  Â  Â  val = meta["draft"]

Â  Â  Â  Â  if isinstance(val, str):

Â  Â  Â  Â  Â  Â  meta["draft"] = val.lower() in ("true", "1", "yes", "on")

Â  Â  Â  Â  else:

Â  Â  Â  Â  Â  Â  meta["draft"] = bool(val)

Â  Â  else:

Â  Â  Â  Â  meta["draft"] = False

  

Â  Â  # æ ‡å‡†åŒ– tags

Â  Â  tags = meta.get("tags", [])

Â  Â  if isinstance(tags, str):

Â  Â  Â  Â  tags = [tags]

Â  Â  elif not isinstance(tags, list):

Â  Â  Â  Â  tags = []

Â  Â  meta["tags"] = [str(t).strip() for t in tags if t]

  

Â  Â  return meta, body

  
  

# ==============================

# ğŸ’¾ æ³¨å…¥ post_id åˆ° .md æ–‡ä»¶

# ==============================

def inject_post_id_to_file(file_path: Path, post_id: int):

Â  Â  with open(file_path, "r", encoding="utf-8") as f:

Â  Â  Â  Â  lines = f.read().splitlines()

  

Â  Â  if not lines or lines[0] != "---":

Â  Â  Â  Â  content = "\n".join(lines)

Â  Â  Â  Â  new_fm = f"""---

post_id: {post_id}

---

  

{content}"""

Â  Â  Â  Â  with open(file_path, "w", encoding="utf-8") as f:

Â  Â  Â  Â  Â  Â  f.write(new_fm)

Â  Â  Â  Â  print(f"ğŸ’¾ å·²åˆ›å»º Front Matter å¹¶å†™å…¥ post_id: {post_id}")

Â  Â  Â  Â  return

  

Â  Â  end_idx = -1

Â  Â  for i in range(1, len(lines)):

Â  Â  Â  Â  if lines[i].strip() == "---":

Â  Â  Â  Â  Â  Â  end_idx = i

Â  Â  Â  Â  Â  Â  break

  

Â  Â  if end_idx == -1:

Â  Â  Â  Â  print("âš ï¸ Front Matter æ ¼å¼ä¸å®Œæ•´ï¼Œè·³è¿‡æ³¨å…¥ post_id", file=sys.stderr)

Â  Â  Â  Â  return

  

Â  Â  has_post_id = any(re.match(r"^\s*post_id\s*:", line) for line in lines[1:end_idx])

Â  Â  if has_post_id:

Â  Â  Â  Â  print("â„¹ï¸ post_id å·²å­˜åœ¨ï¼Œæ— éœ€æ³¨å…¥")

Â  Â  Â  Â  return

  

Â  Â  lines.insert(end_idx, f"post_id: {post_id}")

  

Â  Â  with open(file_path, "w", encoding="utf-8") as f:

Â  Â  Â  Â  f.write("\n".join(lines) + "\n")

  

Â  Â  print(f"âœ… æˆåŠŸæ³¨å…¥ post_id: {post_id} åˆ° {file_path.name}")

  
  

# ==============================

# ğŸ” è·å–å·²æœ‰æ–‡ç« è¯¦æƒ…

# ==============================

def get_post(post_id: int):

Â  Â  url = f"https://i.cnblogs.com/api/posts/{post_id}"

Â  Â  headers = {

Â  Â  Â  Â  "Cookie": COOKIE,

Â  Â  Â  Â  "X-XSRF-TOKEN": XSRF_TOKEN,

Â  Â  Â  Â  "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",

Â  Â  }

Â  Â  try:

Â  Â  Â  Â  resp = requests.get(url, headers=headers, timeout=10)

Â  Â  Â  Â  if resp.status_code == 200:

Â  Â  Â  Â  Â  Â  return resp.json()

Â  Â  Â  Â  else:

Â  Â  Â  Â  Â  Â  print(f"âš ï¸ è·å–åŸæ–‡å¤±è´¥ (ID={post_id})ï¼ŒçŠ¶æ€ç : {resp.status_code}", file=sys.stderr)

Â  Â  Â  Â  Â  Â  return None

Â  Â  except Exception as e:

Â  Â  Â  Â  print(f"âš ï¸ è·å–åŸæ–‡å¼‚å¸¸: {e}", file=sys.stderr)

Â  Â  Â  Â  return None

  
  

# ==============================

# ğŸ“¡ å‘é€è¯·æ±‚ï¼ˆç»Ÿä¸€ POST /api/postsï¼‰

# ==============================

def _send_request(url: str, payload: dict, method: str = "POST"):

Â  Â  headers = {

Â  Â  Â  Â  "Accept": "application/json, text/plain, */*",

Â  Â  Â  Â  "Content-Type": "application/json",

Â  Â  Â  Â  "Origin": "https://i.cnblogs.com",

Â  Â  Â  Â  "Referer": "https://i.cnblogs.com/posts/edit",

Â  Â  Â  Â  "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",

Â  Â  Â  Â  "Cookie": COOKIE,

Â  Â  Â  Â  "X-XSRF-TOKEN": XSRF_TOKEN,

Â  Â  }

  

Â  Â  resp = requests.request(method, url, headers=headers, json=payload, timeout=30)

Â  Â  if resp.status_code in (200, 201):

Â  Â  Â  Â  data = resp.json()

Â  Â  Â  Â  action = "æ›´æ–°" if "id" in payload and payload["id"] else "å‘å¸ƒ"

Â  Â  Â  Â  print(f"âœ… {action}æˆåŠŸï¼ID: {data['id']}")

Â  Â  Â  Â  print(f"ğŸ”— é“¾æ¥: {data['url']}")

Â  Â  Â  Â  return data

Â  Â  else:

Â  Â  Â  Â  print(f"âŒ è¯·æ±‚å¤±è´¥ï¼çŠ¶æ€ç : {resp.status_code}", file=sys.stderr)

Â  Â  Â  Â  print(f"å“åº”: {resp.text}", file=sys.stderr)

Â  Â  Â  Â  resp.raise_for_status()

  
  

# ==============================

# ğŸš€ ç»Ÿä¸€å‘å¸ƒ/æ›´æ–°å‡½æ•°

# ==============================

def publish_or_update(title: str, content: str, tags: list, is_draft: bool, post_id: int = None):

Â  Â  url = "https://i.cnblogs.com/api/posts"

Â  Â  payload = {

Â  Â  Â  Â  "title": title,

Â  Â  Â  Â  "postBody": content,

Â  Â  Â  Â  "isMarkdown": True,

Â  Â  Â  Â  "isDraft": is_draft,

Â  Â  Â  Â  "isPublished": not is_draft,

Â  Â  Â  Â  "postType": 1,

Â  Â  Â  Â  "accessPermission": 268435456,

Â  Â  Â  Â  "includeInMainSyndication": True,

Â  Â  Â  Â  "displayOnHomePage": True,

Â  Â  Â  Â  "isAllowComments": True,

Â  Â  Â  Â  "tags": tags,

Â  Â  Â  Â  "usingEditorId": 5,

Â  Â  }

  

Â  Â  if post_id:

Â  Â  Â  Â  original = get_post(post_id)

Â  Â  Â  Â  if not original:

Â  Â  Â  Â  Â  Â  raise RuntimeError(f"æ— æ³•è·å–åŸæ–‡ä¿¡æ¯ï¼ŒID: {post_id}")

  

Â  Â  Â  Â  payload["id"] = post_id

Â  Â  Â  Â  # ç›´æ¥ä½¿ç”¨åŸå§‹ datePublishedï¼ˆæ ¼å¼ä¸º "2025-11-22T13:15:00.000Z"ï¼‰

Â  Â  Â  Â  if original.get("datePublished"):

Â  Â  Â  Â  Â  Â  payload["datePublished"] = original["datePublished"]

Â  Â  Â  Â  # è¡¥å……å…¶ä»–å­—æ®µï¼ˆéå¿…éœ€ï¼Œä½†æ›´è´´è¿‘æµè§ˆå™¨è¡Œä¸ºï¼‰

Â  Â  Â  Â  for key in ["author", "blogId", "url"]:

Â  Â  Â  Â  Â  Â  if key in original:

Â  Â  Â  Â  Â  Â  Â  Â  payload[key] = original[key]

  

Â  Â  return _send_request(url, payload, method="POST")

  
  

# ==============================

# â–¶ï¸ ä¸»ç¨‹åº

# ==============================

def main():

Â  Â  if len(sys.argv) != 2:

Â  Â  Â  Â  print("ç”¨æ³•: python publish_to_cnblogs.py <ç¬”è®°æ–‡ä»¶.md>", file=sys.stderr)

Â  Â  Â  Â  sys.exit(1)

  

Â  Â  md_file = Path(sys.argv[1])

Â  Â  if not md_file.is_file():

Â  Â  Â  Â  print(f"âŒ æ–‡ä»¶ä¸å­˜åœ¨: {md_file}", file=sys.stderr)

Â  Â  Â  Â  sys.exit(1)

  

Â  Â  print(f"ğŸ“– æ­£åœ¨è¯»å–: {md_file}")

Â  Â  with open(md_file, "r", encoding="utf-8") as f:

Â  Â  Â  Â  raw = f.read()

  

Â  Â  meta, body = parse_front_matter(raw)

  

Â  Â  title = meta.get("title") or md_file.stem.replace("-", " ").title()

Â  Â  tags = meta.get("tags", [])

Â  Â  is_draft = meta.get("draft", False)

Â  Â  post_id = meta.get("post_id")

  

Â  Â  if post_id:

Â  Â  Â  Â  try:

Â  Â  Â  Â  Â  Â  post_id = int(post_id)

Â  Â  Â  Â  except (TypeError, ValueError):

Â  Â  Â  Â  Â  Â  print(f"âš ï¸ post_id æ ¼å¼æ— æ•ˆ: {post_id}ï¼Œå°†ä½œä¸ºæ–°æ–‡ç« å‘å¸ƒ", file=sys.stderr)

Â  Â  Â  Â  Â  Â  post_id = None

  

Â  Â  print(f"ğŸ“ æ ‡é¢˜: {title}")

Â  Â  print(f"ğŸ·ï¸ Â æ ‡ç­¾: {tags}")

Â  Â  print(f"âœï¸ Â è‰ç¨¿æ¨¡å¼: {'æ˜¯' if is_draft else 'å¦'}")

  

Â  Â  if post_id:

Â  Â  Â  Â  print(f"ğŸ”„ æ“ä½œ: æ›´æ–°å·²æœ‰æ–‡ç«  (ID: {post_id})")

Â  Â  Â  Â  result = publish_or_update(

Â  Â  Â  Â  Â  Â  title=title, content=body, tags=tags, is_draft=is_draft, post_id=post_id

Â  Â  Â  Â  )

Â  Â  else:

Â  Â  Â  Â  print("ğŸ†• æ“ä½œ: å‘å¸ƒæ–°æ–‡ç« ")

Â  Â  Â  Â  result = publish_or_update(

Â  Â  Â  Â  Â  Â  title=title, content=body, tags=tags, is_draft=is_draft

Â  Â  Â  Â  )

Â  Â  Â  Â  inject_post_id_to_file(md_file, result["id"])

  
  

if __name__ == "__main__":

Â  Â  main()
```

### åœ¨githubä¸Šåˆ›å»ºå·¥ä½œæµè‡ªåŠ¨åŒ–è¿è¡Œ
ç¼–å†™å·¥ä½œæµé…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼Œå…¶ä¸­é…ç½®ä¿¡æ¯æ ¹æ®è‡ªå·±çš„éœ€æ±‚æ›´æ¢ã€‚
è®°å¾—ä¸ºpythonçš„è„šæœ¬å†™ä¸€æ¡requirements.txt
```
name: åšå®¢å‘å¸ƒå·¥ä½œæµ

  

on:

Â  push:

Â  Â  branches: [ master ]

Â  Â  paths:

Â  Â  Â  - 'blogs/**/*.md'

  

jobs:

Â  publish:

Â  Â  runs-on: ubuntu-latest

Â  Â  steps:

Â  Â  Â  - name: ğŸ›ï¸ Checkout ä»£ç 

Â  Â  Â  Â  uses: actions/checkout@v4

Â  Â  Â  Â  with:

Â  Â  Â  Â  Â  token: ${{ secrets.GITHUB_TOKEN }}

Â  Â  Â  Â  Â  fetch-depth: 0

  

Â  Â  Â  - name: ğŸ è®¾ç½® Python

Â  Â  Â  Â  uses: actions/setup-python@v5

Â  Â  Â  Â  with:

Â  Â  Â  Â  Â  python-version: '3.10'

  

Â  Â  Â  - name: ğŸ“¦ å®‰è£…ä¾èµ–

Â  Â  Â  Â  run: pip install -r scripts/requirements.txt

  

Â  Â  Â  - name: ğŸ”„ æ‰¹é‡å‘å¸ƒæ‰€æœ‰å˜æ›´çš„åšå®¢æ–‡ç« 

Â  Â  Â  Â  env:

Â  Â  Â  Â  Â  CNBLOGS_COOKIE: ${{ secrets.CNBLOGS_COOKIE }}

Â  Â  Â  Â  Â  CNBLOGS_XSRF_TOKEN: ${{ secrets.CNBLOGS_XSRF_TOKEN }}

Â  Â  Â  Â  Â  PREV_COMMIT: ${{ github.event.before }}

Â  Â  Â  Â  Â  CUR_COMMIT: ${{ github.sha }}

Â  Â  Â  Â  run: |

Â  Â  Â  Â  Â  # æ›´ç¨³å¥åœ°è·å–æœ¬æ¬¡æäº¤ä¸­æ–°å¢(A)æˆ–ä¿®æ”¹(M)çš„ blogs/ ä¸‹çš„ .md æ–‡ä»¶

Â  Â  Â  Â  Â  echo "ğŸ” æ­£åœ¨æ£€æµ‹å˜æ›´çš„ Markdown æ–‡ä»¶..."

  

Â  Â  Â  Â  Â  # å¤„ç†ä¸¤ç§æƒ…å†µï¼šæ™®é€š pushï¼ˆæœ‰ä¸Šä¸€ä¸ª commitï¼‰å’Œåˆå§‹æäº¤ï¼ˆbefore ä¸º 000...0ï¼‰

Â  Â  Â  Â  Â  if [ "$PREV_COMMIT" = "0000000000000000000000000000000000000000" ]; then

Â  Â  Â  Â  Â  Â  files=$(git -c core.quotepath=false ls-tree -r --name-only "$CUR_COMMIT" | grep '^blogs/.*\.md$' || true)

Â  Â  Â  Â  Â  else

Â  Â  Â  Â  Â  Â  files=$(git -c core.quotepath=false diff --name-only --diff-filter=AM "$PREV_COMMIT" "$CUR_COMMIT" | grep '^blogs/.*\.md$' || true)

Â  Â  Â  Â  Â  fi

  

Â  Â  Â  Â  Â  if [ -z "$files" ]; then

Â  Â  Â  Â  Â  Â  echo "â„¹ï¸ æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ .md æ–‡ä»¶ï¼ˆæ–°å¢æˆ–ä¿®æ”¹ï¼‰ï¼Œè·³è¿‡å‘å¸ƒæ­¥éª¤ã€‚"

Â  Â  Â  Â  Â  Â  exit 0

Â  Â  Â  Â  Â  fi

  

Â  Â  Â  Â  Â  echo "âœ… æ£€æµ‹åˆ°ä»¥ä¸‹æ–‡ä»¶ï¼š"

Â  Â  Â  Â  Â  echo "$files"

  

Â  Â  Â  Â  Â  # é€ä¸ªå‘å¸ƒ

Â  Â  Â  Â  Â  any_modified=false

Â  Â  Â  Â  Â  while IFS= read -r file; do

Â  Â  Â  Â  Â  Â  if [ -n "$file" ] && [ -f "$file" ]; then

Â  Â  Â  Â  Â  Â  Â  echo ""

Â  Â  Â  Â  Â  Â  Â  echo "ğŸ“¤ æ­£åœ¨å¤„ç†: $file"

  

Â  Â  Â  Â  Â  Â  Â  # è®°å½•å‘å¸ƒå‰çš„æ–‡ä»¶çŠ¶æ€ï¼ˆç”¨äºåˆ¤æ–­æ˜¯å¦æ³¨å…¥äº† post_idï¼‰

Â  Â  Â  Â  Â  Â  Â  before_hash=$(sha256sum "$file")

  

Â  Â  Â  Â  Â  Â  Â  # è°ƒç”¨å‘å¸ƒè„šæœ¬

Â  Â  Â  Â  Â  Â  Â  python scripts/publish_to_cnblogs.py "$file"

  

Â  Â  Â  Â  Â  Â  Â  # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦è¢«ä¿®æ”¹ï¼ˆå³æ³¨å…¥äº† post_idï¼‰

Â  Â  Â  Â  Â  Â  Â  after_hash=$(sha256sum "$file")

Â  Â  Â  Â  Â  Â  Â  if [ "$before_hash" != "$after_hash" ]; then

Â  Â  Â  Â  Â  Â  Â  Â  echo "âœ¨ $file å·²æ›´æ–° post_id"

Â  Â  Â  Â  Â  Â  Â  Â  git add "$file"

Â  Â  Â  Â  Â  Â  Â  Â  any_modified=true

Â  Â  Â  Â  Â  Â  Â  else

Â  Â  Â  Â  Â  Â  Â  Â  echo "â„¹ï¸ $file æ— å˜åŒ–ï¼ˆå¯èƒ½å·²æ˜¯å·²å‘å¸ƒæ–‡ç« ï¼‰"

Â  Â  Â  Â  Â  Â  Â  fi

Â  Â  Â  Â  Â  Â  fi

Â  Â  Â  Â  Â  done <<< "$files"

  

Â  Â  Â  Â  Â  # å¦‚æœæœ‰æ–‡ä»¶è¢«ä¿®æ”¹ï¼Œæäº¤å¹¶æ¨é€

Â  Â  Â  Â  Â  if [ "$any_modified" = true ]; then

Â  Â  Â  Â  Â  Â  echo ""

Â  Â  Â  Â  Â  Â  echo "ğŸ’¾ æ­£åœ¨æäº¤æ›´æ–°åçš„æ–‡ä»¶..."

Â  Â  Â  Â  Â  Â  git config --global user.name "github-actions[bot]"

Â  Â  Â  Â  Â  Â  git config --global user.email "github-actions[bot]@users.noreply.github.com"

Â  Â  Â  Â  Â  Â  git commit -m "chore: auto inject post_id for published posts"

Â  Â  Â  Â  Â  Â  git push

Â  Â  Â  Â  Â  Â  echo "âœ… å·²æˆåŠŸæ¨é€ post_id æ›´æ–°ï¼"

Â  Â  Â  Â  Â  else

Â  Â  Â  Â  Â  Â  echo ""

Â  Â  Â  Â  Â  Â  echo "â„¹ï¸ æœ¬æ¬¡æ— æ–°æ–‡ç« å‘å¸ƒï¼Œæ— éœ€æäº¤ã€‚"

Â  Â  Â  Â  Â  fi
```